<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kh√°ch H√†ng - Deluxe Restaurant</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a1a;
            --accent: #d4af37;
            --accent-dark: #b8962e;
            --bg: #faf8f3;
            --text: #2c2c2c;
            --text-light: #666;
            --border: #e5dcc9;
            --error: #c73e1d;
            --success: #2d7d46;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            font-weight: 600;
            color: var(--primary);
            letter-spacing: 2px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-name {
            font-size: 14px;
            color: var(--text-light);
        }

        .btn-logout {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 2px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: var(--accent);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        /* Section */
        .section {
            background: white;
            border-radius: 2px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .section-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .section-subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 30px;
        }

        #cart-notice {
            background: rgba(217, 119, 6, 0.1);
            border-left: 3px solid var(--warning);
            padding: 12px 16px;
            border-radius: 2px;
            color: var(--warning);
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* Booking Section */
        .floor-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .floor-card {
            padding: 30px 20px;
            border: 2px solid var(--border);
            border-radius: 2px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .floor-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.2);
        }

        .floor-card.selected {
            border-color: var(--accent);
            background: rgba(212, 175, 55, 0.05);
        }

        .floor-card h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .floor-card p {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Current Booking */
        .current-booking {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
            border-left: 4px solid var(--accent);
            padding: 25px;
            border-radius: 2px;
            margin-bottom: 30px;
        }

        .booking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .booking-detail {
            display: flex;
            flex-direction: column;
        }

        .booking-detail label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .booking-detail span {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        /* Menu */
        .menu-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 2px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover, .filter-btn.active {
            border-color: var(--accent);
            background: rgba(212, 175, 55, 0.05);
            color: var(--accent-dark);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .menu-item {
            border: 1px solid var(--border);
            border-radius: 2px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .menu-item-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f5f0e5 0%, #e5dcc9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cormorant Garamond', serif;
            font-size: 48px;
            color: var(--accent);
        }

        .menu-item-content {
            padding: 20px;
        }

        .menu-item-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .menu-item-desc {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .menu-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-item-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-dark);
        }

        .btn-add {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 2px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            background: var(--accent);
        }

        /* Cart */
        .cart-items {
            margin-bottom: 25px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 2px;
            margin-bottom: 15px;
            background: white;
        }

        .cart-item-info h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .cart-item-info p {
            font-size: 14px;
            color: var(--text-light);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 2px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            border-color: var(--accent);
            background: rgba(212, 175, 55, 0.1);
        }

        .btn-remove {
            padding: 8px 16px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 2px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            background: #a83219;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 2px;
            margin-bottom: 25px;
        }

        .cart-total span:first-child {
            font-size: 18px;
            font-weight: 600;
        }

        .cart-total span:last-child {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-dark);
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 2px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Alert */
        .alert {
            padding: 16px 20px;
            border-radius: 2px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .alert.show {
            display: block;
        }

        .alert.error {
            background: #fef2f2;
            border-left: 4px solid var(--error);
            color: var(--error);
        }

        .alert.success {
            background: #f0fdf4;
            border-left: 4px solid var(--success);
            color: var(--success);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            .section {
                padding: 25px 20px;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>DELUXE</h1>
            </div>
            <div class="user-info">
                <span class="user-name" id="user-name"></span>
                <button class="btn-logout" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="alert" id="alert"></div>

        <!-- Booking Section -->
        <div class="section" id="booking-section">
            <h2 class="section-title">ƒê·∫∑t B√†n</h2>
            <p class="section-subtitle">Ch·ªçn t·∫ßng b·∫°n mu·ªën ng·ªìi</p>

            <div class="floor-options">
                <div class="floor-card" onclick="selectFloor('T·∫ßng 1')">
                    <h3>T·∫ßng 1</h3>
                    <p>B√†n ti√™u chu·∫©n 4 gh·∫ø</p>
                </div>
                <div class="floor-card" onclick="selectFloor('T·∫ßng 2')">
                    <h3>T·∫ßng 2</h3>
                    <p>B√†n gia ƒë√¨nh 6 gh·∫ø</p>
                </div>
                <div class="floor-card" onclick="selectFloor('T·∫ßng 3')">
                    <h3>T·∫ßng 3</h3>
                    <p>B√†n VIP 8-10 gh·∫ø</p>
                </div>
            </div>

            <button class="btn-primary" id="btn-book" onclick="bookTable()">ƒê·∫∑t B√†n Ngay</button>
        </div>

        <!-- Current Booking -->
        <div class="section hidden" id="current-booking-section">
            <h2 class="section-title">B√†n Hi·ªán T·∫°i</h2>
            <div class="current-booking">
                <div class="booking-info" id="booking-info"></div>
            </div>
            <button class="btn-primary" onclick="checkout()" style="background: var(--success);">Thanh To√°n</button>
        </div>

        <!-- Menu Section -->
        <div class="section" id="menu-section">
            <h2 class="section-title">Th·ª±c ƒê∆°n</h2>
            <p class="section-subtitle">Ch·ªçn m√≥n b·∫°n mu·ªën g·ªçi</p>

            <div class="menu-filters">
                <button class="filter-btn active" onclick="filterMenu(null)">T·∫•t C·∫£</button>
                <button class="filter-btn" onclick="filterMenu(1)">ƒê·ªì ƒÇn</button>
                <button class="filter-btn" onclick="filterMenu(2)">ƒê·ªì U·ªëng</button>
            </div>

            <div class="menu-grid" id="menu-grid"></div>
        </div>

        <!-- Cart Section -->
        <div class="section" id="cart-section">
            <h2 class="section-title">Gi·ªè H√†ng</h2>
            <p class="section-subtitle" id="cart-notice">Vui l√≤ng ƒë·∫∑t b√†n tr∆∞·ªõc khi g·ªçi m√≥n</p>
            <div class="cart-items" id="cart-items"></div>
            <div class="cart-total">
                <span>T·ªïng C·ªông:</span>
                <span id="cart-total">0 ‚Ç´</span>
            </div>
            <button class="btn-primary" id="btn-order" onclick="submitOrder()" disabled>G·ªçi M√≥n</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || 'null');
        let selectedFloor = null;
        let currentBooking = null;
        let menuItems = [];
        let cart = [];

        // Check authentication
        if (!token || !user) {
            window.location.href = 'index.html';
        }

        // Display user name
        document.getElementById('user-name').textContent = user.ho_ten;

        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // Show alert
        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // Select floor
        function selectFloor(floor) {
            selectedFloor = floor;
            document.querySelectorAll('.floor-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.floor-card').classList.add('selected');
        }

        // Book table
        async function bookTable() {
            if (!selectedFloor) {
                showAlert('Vui l√≤ng ch·ªçn t·∫ßng');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/dat-ban`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ vi_tri: selectedFloor })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('ƒê·∫∑t b√†n th√†nh c√¥ng! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ g·ªçi m√≥n.', 'success');
                    await loadCurrentBooking();
                } else {
                    showAlert(result.message || 'ƒê·∫∑t b√†n th·∫•t b·∫°i');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi server');
                console.error(error);
            }
        }

        // Load current booking
        async function loadCurrentBooking() {
            try {
                const response = await fetch(`${API_URL}/dat-ban/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    currentBooking = result.booking;
                    
                    // Hide booking section, show current booking
                    document.getElementById('booking-section').classList.add('hidden');
                    document.getElementById('current-booking-section').classList.remove('hidden');
                    
                    // Enable order button
                    document.getElementById('btn-order').disabled = false;
                    document.getElementById('cart-notice').style.display = 'none';

                    const bookingInfo = document.getElementById('booking-info');
                    bookingInfo.innerHTML = `
                        <div class="booking-detail">
                            <label>S·ªë B√†n</label>
                            <span>${currentBooking.so_ban}</span>
                        </div>
                        <div class="booking-detail">
                            <label>V·ªã Tr√≠</label>
                            <span>${currentBooking.vi_tri}</span>
                        </div>
                        <div class="booking-detail">
                            <label>T·ªïng Ti·ªÅn</label>
                            <span>${formatPrice(currentBooking.total_price || 0)}</span>
                        </div>
                    `;
                } else {
                    // Show booking section, hide current booking
                    document.getElementById('booking-section').classList.remove('hidden');
                    document.getElementById('current-booking-section').classList.add('hidden');
                    
                    // Disable order button until booked
                    document.getElementById('btn-order').disabled = true;
                    document.getElementById('cart-notice').style.display = 'block';
                }
            } catch (error) {
                console.error(error);
            }
        }

        // Load menu
        async function loadMenu() {
            try {
                const response = await fetch(`${API_URL}/thuc-don`);
                const result = await response.json();
                menuItems = result.items;
                displayMenu(menuItems);
            } catch (error) {
                console.error(error);
            }
        }

        // Display menu
        function displayMenu(items) {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = items.map(item => `
                <div class="menu-item">
                    <div class="menu-item-image">üçΩÔ∏è</div>
                    <div class="menu-item-content">
                        <h3 class="menu-item-name">${item.ten_mon}</h3>
                        <p class="menu-item-desc">${item.mo_ta || 'M√≥n ƒÉn ngon'}</p>
                        <div class="menu-item-footer">
                            <span class="menu-item-price">${formatPrice(item.gia)}</span>
                            <button class="btn-add" onclick="addToCart(${item.id})">Th√™m</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter menu
        function filterMenu(categoryId) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const filtered = categoryId ? menuItems.filter(item => item.danh_muc_id === categoryId) : menuItems;
            displayMenu(filtered);
        }

        // Add to cart
        function addToCart(itemId) {
            const item = menuItems.find(m => m.id === itemId);
            const existing = cart.find(c => c.mon_an_id === itemId);

            if (existing) {
                existing.so_luong++;
            } else {
                cart.push({
                    mon_an_id: itemId,
                    ten_mon: item.ten_mon,
                    gia: item.gia,
                    so_luong: 1
                });
            }

            updateCart();
            showAlert('ƒê√£ th√™m v√†o gi·ªè h√†ng', 'success');
        }

        // Update cart display
        function updateCart() {
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');

            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: var(--text-light);">Gi·ªè h√†ng tr·ªëng</p>';
                cartTotal.textContent = '0 ‚Ç´';
                return;
            }

            cartItems.innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <h4>${item.ten_mon}</h4>
                        <p>${formatPrice(item.gia)} x ${item.so_luong}</p>
                    </div>
                    <div class="cart-item-controls">
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
                            <span>${item.so_luong}</span>
                            <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
                        </div>
                        <button class="btn-remove" onclick="removeFromCart(${index})">X√≥a</button>
                    </div>
                </div>
            `).join('');

            const total = cart.reduce((sum, item) => sum + (item.gia * item.so_luong), 0);
            cartTotal.textContent = formatPrice(total);
        }

        // Update quantity
        function updateQuantity(index, change) {
            cart[index].so_luong += change;
            if (cart[index].so_luong <= 0) {
                cart.splice(index, 1);
            }
            updateCart();
        }

        // Remove from cart
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCart();
        }

        // Submit order
        async function submitOrder() {
            if (cart.length === 0) {
                showAlert('Gi·ªè h√†ng tr·ªëng');
                return;
            }

            if (!currentBooking) {
                showAlert('Vui l√≤ng ƒë·∫∑t b√†n tr∆∞·ªõc');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/goi-mon`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        dat_ban_id: currentBooking.id,
                        items: cart
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('G·ªçi m√≥n th√†nh c√¥ng!', 'success');
                    cart = [];
                    updateCart();
                    await loadCurrentBooking();
                } else {
                    showAlert(result.message || 'G·ªçi m√≥n th·∫•t b·∫°i');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi server');
                console.error(error);
            }
        }

        // Checkout
        async function checkout() {
            if (!currentBooking) return;

            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën thanh to√°n?')) return;

            try {
                const response = await fetch(`${API_URL}/dat-ban/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ dat_ban_id: currentBooking.id })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(`Thanh to√°n th√†nh c√¥ng! T·ªïng: ${formatPrice(result.total_price)}`, 'success');
                    currentBooking = null;
                    cart = [];
                    updateCart();
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert(result.message || 'Thanh to√°n th·∫•t b·∫°i');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi server');
                console.error(error);
            }
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        // Initialize
        loadCurrentBooking();
        loadMenu(); // Load menu immediately on page load
    </script>
</body>
</html>
